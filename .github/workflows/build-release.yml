name: Build Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v0.2.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æŽˆäºˆå¿…è¦çš„æƒé™
permissions:
  contents: write  # åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶éœ€è¦å†™æƒé™
  
jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            artifact_name: Fieldnotes-Linux-x86_64.tar.gz
            build_command: bash scripts/build_executable.sh
            
          - os: windows-latest
            platform: Windows
            artifact_name: Fieldnotes-Windows.zip
            build_command: scripts\build_executable.bat
            
          - os: macos-latest
            platform: macOS
            artifact_name: Fieldnotes-macOS.tar.gz
            build_command: bash scripts/build_executable.sh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
          $env:PATH = "$env:APPDATA\Python\Scripts;$env:PATH"
          echo "$env:APPDATA\Python\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          & "$env:APPDATA\Python\Scripts\poetry" config virtualenvs.create true
          & "$env:APPDATA\Python\Scripts\poetry" config virtualenvs.in-project true

      - name: Install Poetry (Linux/macOS)
        if: runner.os != 'Windows'
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-root --with dev
          echo "âœ… Dependencies installed"
          poetry run python --version
          poetry run pip list | grep -i pyinstaller || echo "âš ï¸ PyInstaller not found"

      - name: Build executable (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          ${{ matrix.build_command }}

      - name: Build executable (Windows)
        if: runner.os == 'Windows'
        run: |
          ${{ matrix.build_command }}

      - name: Create distribution package (Linux)
        if: runner.os == 'Linux'
        run: |
          cd dist
          tar -czf ${{ matrix.artifact_name }} Fieldnotes/

      - name: Create distribution package (macOS)
        if: runner.os == 'macOS'
        run: |
          cd dist
          tar -czf ${{ matrix.artifact_name }} Fieldnotes.app

      - name: Create distribution package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\Fieldnotes -DestinationPath dist\${{ matrix.artifact_name }}

      - name: Calculate SHA256
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            cd dist && certutil -hashfile ${{ matrix.artifact_name }} SHA256 > ${{ matrix.artifact_name }}.sha256
          else
            cd dist && shasum -a 256 ${{ matrix.artifact_name }} > ${{ matrix.artifact_name }}.sha256
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            dist/${{ matrix.artifact_name }}
            dist/${{ matrix.artifact_name }}.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Prepare Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # åˆ›å»º Release Notes å¤´éƒ¨
          cat > release_notes.md << 'NOTES_EOF'
          ## Fieldnotes Lite ${{ steps.get_version.outputs.VERSION }}
          
          ç”°é‡Žç¬”è®°ç®¡ç†å·¥å…· - ä¸“ä¸ºè¯­è¨€å­¦ç”°é‡Žè°ƒæŸ¥è®¾è®¡çš„è¯­æ–™ç®¡ç†ä¸Žå¯¼å‡ºå·¥å…·
          
          ### ðŸ“¦ ä¸‹è½½å®‰è£…åŒ…
          
          | å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |
          |------|------|------|
          | ðŸªŸ Windows | `Fieldnotes-Windows.zip` | è§£åŽ‹åŽè¿è¡Œ `Fieldnotes.exe` |
          | ðŸŽ macOS | `Fieldnotes-macOS.tar.gz` | è§£åŽ‹åŽåŒå‡» `Fieldnotes.app` |
          | ðŸ§ Linux | `Fieldnotes-Linux-x86_64.tar.gz` | è§£åŽ‹åŽè¿è¡Œ `./Fieldnotes` |
          
          ### ðŸ” æ–‡ä»¶æ ¡éªŒ
          
          æ¯ä¸ªå®‰è£…åŒ…éƒ½é™„å¸¦ `.sha256` æ ¡éªŒæ–‡ä»¶ï¼š
          
          ```bash
          # macOS/Linux
          shasum -a 256 -c Fieldnotes-*.sha256
          
          # Windows PowerShell
          Get-FileHash Fieldnotes-Windows.zip -Algorithm SHA256
          ```
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          **macOS ç”¨æˆ·**ï¼š
          1. è§£åŽ‹ `Fieldnotes-macOS.tar.gz`
          2. å³é”®ç‚¹å‡» `Fieldnotes.app` â†’ é€‰æ‹©"æ‰“å¼€"ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
          3. åŽç»­å¯ç›´æŽ¥åŒå‡»å¯åŠ¨
          
          **Windows ç”¨æˆ·**ï¼š
          1. è§£åŽ‹ `Fieldnotes-Windows.zip`
          2. åŒå‡» `Fieldnotes.exe`
          3. å¦‚æç¤ºå®‰å…¨è­¦å‘Šï¼Œé€‰æ‹©"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
          
          **Linux ç”¨æˆ·**ï¼š
          1. è§£åŽ‹ `Fieldnotes-Linux-x86_64.tar.gz`
          2. æ·»åŠ æ‰§è¡Œæƒé™ï¼š`chmod +x Fieldnotes/Fieldnotes`
          3. è¿è¡Œï¼š`./Fieldnotes/Fieldnotes`
          
          ---
          
          NOTES_EOF
          
          # ä»Ž CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
          if [ -f "CHANGELOG.md" ]; then
            echo "" >> release_notes.md
            echo "## ðŸ“‹ æ›´æ–°å†…å®¹" >> release_notes.md
            echo "" >> release_notes.md
            
            # æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
            VERSION_NUM="${VERSION#v}"
            
            # ä½¿ç”¨ awk æå–å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹
            awk -v ver="$VERSION_NUM" '
              /^## \['"$VERSION_NUM"'\]/ {found=1; next}
              found && /^## \[/ {exit}
              found {print}
            ' CHANGELOG.md >> release_notes.md
            
            if [ $? -eq 0 ]; then
              echo "âœ… æˆåŠŸä»Ž CHANGELOG.md æå– ${VERSION} çš„æ›´æ–°å†…å®¹"
            else
              echo "âš ï¸ æ— æ³•ä»Ž CHANGELOG.md æå–å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž"
              echo "è¯¦è§ [CHANGELOG](https://github.com/ruiliapt/fieldnotes/blob/main/CHANGELOG.md)" >> release_notes.md
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° CHANGELOG.md"
            echo "" >> release_notes.md
            echo "è¯¦è§é¡¹ç›® [README](https://github.com/ruiliapt/fieldnotes/blob/main/README.md)" >> release_notes.md
          fi
          
          # æ·»åŠ æ–‡æ¡£é“¾æŽ¥
          cat >> release_notes.md << 'FOOTER_EOF'
          
          ---
          
          ### ðŸ“– æ–‡æ¡£ä¸Žæ”¯æŒ
          
          - **[README](https://github.com/ruiliapt/fieldnotes/blob/main/README.md)** - é¡¹ç›®è¯´æ˜Ž
          - **[å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/ruiliapt/fieldnotes/blob/main/CHANGELOG.md)** - æ‰€æœ‰ç‰ˆæœ¬åŽ†å²
          - **[å¿«é€ŸæŒ‡å—](https://github.com/ruiliapt/fieldnotes/blob/main/docs/user/ONE_PAGE_GUIDE.md)** - 5åˆ†é’Ÿä¸Šæ‰‹
          - **[ä½¿ç”¨æ•™ç¨‹](https://github.com/ruiliapt/fieldnotes/blob/main/docs/user/USER_GUIDE_NON_TECHNICAL.md)** - è¯¦ç»†å›¾æ–‡
          - **[æ•…éšœæŽ’æŸ¥](https://github.com/ruiliapt/fieldnotes/blob/main/docs/TROUBLESHOOTING.md)** - å¸¸è§é—®é¢˜
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          
          é‡åˆ°é—®é¢˜ï¼Ÿè¯·è®¿é—® [Issues](https://github.com/ruiliapt/fieldnotes/issues) æäº¤é—®é¢˜æŠ¥å‘Šã€‚
          FOOTER_EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
          body_path: release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

